

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>CNMFE &mdash; Mesmerize 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../_static/sphinxcontrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
        <script type="text/javascript" src="../../../_static/sphinxcontrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
        <script type="text/javascript" src="../../../_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinxcontrib-images/LightBox2/lightbox2/css/lightbox.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Script Editor" href="script_editor.html" />
    <link rel="prev" title="CNMF" href="cnmf.html" />
    <link href="../../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Mesmerize
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../citation_guide.html">Citation guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Project Organization:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../project_organization/new_project/new_project.html">Create a New Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_organization/project_browser/project_browser.html">Project Browser</a></li>
</ul>
<p class="caption"><span class="caption-text">Viewer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Viewer overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../convert_meta_data.html">Convert Meta Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../add_to_project.html">Add a Sample to the Project</a></li>
</ul>
<p class="caption"><span class="caption-text">Viewer Modules</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="tiff_file.html">Tiff file module</a></li>
<li class="toctree-l1"><a class="reference internal" href="batch_manager.html">Batch Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="stimulus_mapping.html">Stimulus Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="roi_manager.html">ROI Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="caiman_motion_correction.html">Caiman Motion Correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="cnmf.html">CNMF</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">CNMFE</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#script-usage">Script Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#add-corr-pnr-items">Add Corr PNR items</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="script_editor.html">Script Editor</a></li>
</ul>
<p class="caption"><span class="caption-text">Flowchart</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../flowchart/overview.html">Flowchart Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flowchart/nodes.html">Nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flowchart/examples.html">Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Plots</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../plots/beeswarm.html">Beeswarm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plots/consoles.html">Consoles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plots/cross_correlation.html">Cross Correlation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plots/datapoint_tracer.html">Datapoint Tracer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plots/heatmap.html">Heatmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plots/kshape.html">KShape</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plots/peak_editor.html">Peak Editor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plots/proportions.html">Proportions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plots/scatter.html">Scatter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plots/simple_plot.html">Simple Plot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plots/spacemap.html">SpaceMap</a></li>
</ul>
<p class="caption"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../general/misc.html">Welcome Window</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/misc.html#project-structure">Project Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/misc.html#project-sample">Project Sample</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/misc.html#consoles">Consoles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/misc.html#saving-plots">Saving plots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/misc.html#plot-navbar">Plot Navbar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/misc.html#system-configuration">System Configuration</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/nodes.html">Nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/plots.html">Plots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/viewer_modules.html">Viewer Modules</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/common.html">Common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/Viewer_data_types.html">Viewer Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/viewer_modules/viewer_modules.html">Viewer Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/viewer_modules/roi_manager.html">ROI Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/viewer_modules/stimulus_mapping.html">Stimulus Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/Analysis_data_types.html">Data types used for analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/analysis.html">Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/nodes.html">Nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/plotting/utils.html">Plotting utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/plotting/widgets/bases.html">Plot Bases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/plotting/widgets/datapoint_tracer.html">Datapoint Tracer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/plotting/widgets/heatmap.html">Heatmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/plotting/widgets/kshape.html">KShape</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/plotting/widgets/proportions.html">Proportions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/plotting/widgets/scatter.html">Scatter Plot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/plotting/widgets/spacemap.html">SpaceMap</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Mesmerize</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
      <li>CNMFE</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/user_guides/viewer/modules/cnmfe.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="cnmfe">
<span id="module-cnmfe"></span><h1>CNMFE<a class="headerlink" href="#cnmfe" title="Permalink to this headline">¶</a></h1>
<p>Perform CNMFE using the implementation provided by the CaImAn library.</p>
<p><strong>I highly recommend going through the following before using this module</strong></p>
<blockquote>
<div><ul>
<li><dl class="first docutils">
<dt>The paper on CNMF-E</dt>
<dd><p class="first last"><a class="reference external" href="https://doi.org/10.7554/eLife.28728">Zhou, P., Resendez, S. L., Rodriguez-Romaguera, J., Jimenez, J. C., Neufeld, S. Q., Stuber, G. D., … Paninski, L. (2016). Efficient and accurate extraction of in vivo calcium signals from microendoscopic video data. ELife, 1–37.</a></p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>CNMFE builds upon CNMF</dt>
<dd><p class="first"><a class="reference external" href="https://arxiv.org/abs/1409.2903">Pnevmatikakis, E. A., Gao, Y., Soudry, D., Pfau, D., Lacefield, C., Poskanzer, K., … Paninski, L. (2014). A structured matrix factorization framework for large scale calcium imaging data analysis, 1–16.</a></p>
<p class="last"><a class="reference external" href="https://doi.org/10.1016/j.neuron.2015.11.037">Pnevmatikakis, E. A., Soudry, D., Gao, Y., Machado, T. A., Merel, J., Pfau, D., … Paninski, L. (2016). Simultaneous Denoising, Deconvolution, and Demixing of Calcium Imaging Data. Neuron, 89(2), 285.</a></p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>CaImAn CNMF-E demo notebook, the implementation in Mesmerize is basically from the demo</dt>
<dd><p class="first last"><a class="reference external" href="https://github.com/flatironinstitute/CaImAn/blob/master/demos/notebooks/demo_pipeline_cnmfE.ipynb">https://github.com/flatironinstitute/CaImAn/blob/master/demos/notebooks/demo_pipeline_cnmfE.ipynb</a></p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<img alt="../../../_images/cnmfe1.png" src="../../../_images/cnmfe1.png" />
<p><strong>Parameters</strong></p>
<p>Please see the CaImAn demo notebook mentioned above to understand the parameters.</p>
<p><strong>Ain</strong>: Seed spatial components from another CNMFE item by entering its UUID here.</p>
<div class="section" id="usage">
<span id="module-cnmfe-usage"></span><h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>This module creates two types of batch items, one where you can inspect the Correlation &amp; PNR images and another that performs CNMFE and extracts components. Here is an outline of typical usage:</p>
<ul class="simple">
<li>Enter a <em>gSig</em> parameter value and a name for “Inspect Correlation and PNR”, the text entry for “Stop here”. Click “Add to batch”. Run the batch item.</li>
<li>Double-click the batch item, you will be presented with a GUI to help optimize <em>min_corr</em> and <em>min_pnr</em>. For the correlation image use the vmin slider to optimize the seperation of cells and set the <em>min_corr</em> parameter to this value. Likewise, optimize the value for the PNR until the PNR image mostly contains regions that show real signal and no or few regions that are likely to be just noise and set this vmin value as the <em>min_pnr</em> parameter. You may need to try slightly different variations to optimize the parameters.</li>
</ul>
<img alt="../../../_images/corr_pnr_img.png" src="../../../_images/corr_pnr_img.png" />
<ul class="simple">
<li>Enter the rest of the parameters and give a name under “Perform CNMF-E”, click “Add to batch” and run the item.</li>
<li>Double-click the batch item and you will be presented with 3 options. The first option will display the correlation-pnr images and the second option is currently non-functional (matplotlib Qt issue). The last option will import the components extracted by CNMFE into an open Viewer. The components are managed by the ROI Manager.</li>
</ul>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="roi_manager.html#roimanager"><span class="std std-ref">ROI Manager</span></a></p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">This modules uses the <a class="reference internal" href="batch_manager.html#module-batchmanager"><span class="std std-ref">Batch Manager</span></a>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The parameters used for CNMFE are stored in the work environment of the viewer and this log is carried over and saved in <span class="xref std std-ref">Project Samples</span> as well. To see the parameters that were used for CNMFE in the viewer, execute <code class="docutils literal notranslate"><span class="pre">get_workEnv().history_trace</span></code> in the viewer console and look for the ‘cnmfe’ entry.</p>
</div>
</div>
<div class="section" id="script-usage">
<h2>Script Usage<a class="headerlink" href="#script-usage" title="Permalink to this headline">¶</a></h2>
<p>A script can be used to add CNMFE batch items. This is much faster than using the GUI.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="script_editor.html#module-scripteditor"><span class="std std-ref">Script Editor</span></a>.</p>
</div>
<div class="section" id="add-corr-pnr-items">
<h3>Add Corr PNR items<a class="headerlink" href="#add-corr-pnr-items" title="Permalink to this headline">¶</a></h3>
<p>Add Corr PNR batch items from a batch that contains motion corrected items. This example add 2 variants of parameters (just gSig) for each motion corrected item.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">This example uses the <a class="reference internal" href="../../../api_reference/viewer_modules/viewer_modules.html#api-cnmfe"><span class="std std-ref">Caiman CNMFE module API</span></a> and <a class="reference internal" href="../../../api_reference/viewer_modules/viewer_modules.html#api-batchmanager"><span class="std std-ref">Batch Manager API</span></a></p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="caiman_motion_correction.html#motcorscripts"><span class="std std-ref">Caiman Motion Correction script usage examples</span></a> for how to load images if you want to add Corr PNR items from images that are not in a batch.</p>
</div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Get the batch manager</span>
<span class="n">bm</span> <span class="o">=</span> <span class="n">get_batch_manager</span><span class="p">()</span>

<span class="c1"># Get the CNMFE module</span>
<span class="n">cnmfe_mod</span> <span class="o">=</span> <span class="n">get_module</span><span class="p">(</span><span class="s1">&#39;cnmfe&#39;</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># Start index to start processing the new items after they have been added</span>
<span class="n">start_ix</span> <span class="o">=</span> <span class="n">bm</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span>

<span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">bm</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="n">start_ix</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Get the name of the mot cor item</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

        <span class="c1"># Load the output of the motion corrected batch item</span>
        <span class="c1"># The output will load into the viewer that this script</span>
        <span class="c1"># is running in.</span>
        <span class="n">bm</span><span class="o">.</span><span class="n">load_item_output</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="s1">&#39;caiman_motion_correction&#39;</span><span class="p">,</span> <span class="n">viewers</span><span class="o">=</span><span class="n">viewer</span><span class="p">,</span> <span class="n">UUID</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>

        <span class="c1"># Get the currently set params</span>
        <span class="c1"># You just need the dict with all the correct keys</span>
        <span class="c1"># You will just modify the &quot;gSig&quot; and &quot;name_corr_pnr&quot; keys</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">cnmfe_mod</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span>

        <span class="c1"># Set the gSig and name params</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;gSig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;name_corr_pnr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1"># Set the params and add to batch</span>
        <span class="n">cnmfe_mod</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">cnmfe_mod</span><span class="o">.</span><span class="n">add_to_batch_corr_pnr</span><span class="p">()</span>

        <span class="c1"># Another variant of params</span>
        <span class="c1"># Set the gSig and name params</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;gSig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;name_corr_pnr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1"># Set the params and add to batch</span>
        <span class="n">cnmfe_mod</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">cnmfe_mod</span><span class="o">.</span><span class="n">add_to_batch_corr_pnr</span><span class="p">()</span>

<span class="c1"># Cleanup the work environment</span>
<span class="n">vi</span><span class="o">.</span><span class="n">_clear_workEnv</span><span class="p">()</span>

<span class="c1"># Start the batch from the start_ix</span>
<span class="n">bm</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span><span class="n">start_ix</span><span class="p">,</span> <span class="n">clear_viewers</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="script_editor.html" class="btn btn-neutral float-right" title="Script Editor" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="cnmf.html" class="btn btn-neutral float-left" title="CNMF" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Kushal Kolar

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>